<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Voice Call</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; text-align: center; padding: 20px; }
    input, button { padding: 10px; margin: 8px; border-radius: 10px; border: none; font-size: 16px; width: 80%; max-width: 300px; }
    button { background: #0f9d58; color: #fff; cursor: pointer; }
    .disabled { background: #555; cursor: not-allowed; }
    h2 { color: #0f9d58; }
  </style>
</head>
<body>
  <h2>Free Voice Call</h2>
  <input id="myId" placeholder="Your ID (for creating room)" />
  <button id="createBtn">Create Room</button>
  <hr style="width: 80%;" />
  <input id="joinId" placeholder="Join Room ID" />
  <button id="joinBtn">Join Room</button>
  <br />
  <button id="micBtn" disabled>Mic On</button>
  <button id="shareBtn" disabled>Share Room</button>
  <div id="status">Status: Not connected</div>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const myIdInput = document.getElementById("myId");
      const joinIdInput = document.getElementById("joinId");
      const createBtn = document.getElementById("createBtn");
      const joinBtn = document.getElementById("joinBtn");
      const micBtn = document.getElementById("micBtn");
      const shareBtn = document.getElementById("shareBtn");
      const status = document.getElementById("status");
      const remoteAudio = document.getElementById("remoteAudio");

      let peer, localStream, currentCall;

      async function getAudioStream() {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          return true;
        } catch {
          alert("Mic access denied");
          return false;
        }
      }

      createBtn.onclick = async () => {
        const id = myIdInput.value.trim();
        if (!id) return alert("Enter your ID to create room.");
        const success = await getAudioStream();
        if (!success) return;

        peer = new Peer(id);
        peer.on("open", () => {
          status.innerText = "Room Created. ID: " + id;
          micBtn.disabled = false;
          shareBtn.disabled = false;
        });

        peer.on("call", call => {
          call.answer(localStream);
          call.on("stream", stream => {
            remoteAudio.srcObject = stream;
            status.innerText = "Connected with " + call.peer;
          });
          currentCall = call;
        });
      };

      joinBtn.onclick = async () => {
        const id = joinIdInput.value.trim();
        if (!id) return alert("Enter Room ID to join.");
        const success = await getAudioStream();
        if (!success) return;

        peer = new Peer();
        peer.on("open", () => {
          const call = peer.call(id, localStream);
          call.on("stream", stream => {
            remoteAudio.srcObject = stream;
            status.innerText = "Connected with " + id;
          });
          currentCall = call;
          micBtn.disabled = false;
        });
      };

      micBtn.onclick = () => {
        const track = localStream.getAudioTracks()[0];
        track.enabled = !track.enabled;
        micBtn.innerText = track.enabled ? "Mic On" : "Mic Off";
      };

      shareBtn.onclick = () => {
        const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(myIdInput.value.trim())}`;
        navigator.clipboard.writeText(url).then(() => alert("Link copied:\n" + url));
      };

      // Auto-join if ?room= param
      const urlParams = new URLSearchParams(location.search);
      const autoRoom = urlParams.get("room");
      if (autoRoom) {
        joinIdInput.value = autoRoom;
        joinBtn.click();
      }
    });
  </script>
</body>
</html>
