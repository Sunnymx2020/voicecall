<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Voice Call Room</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    input, button { font-size: 16px; padding: 8px; margin: 8px; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>WebRTC Voice Call</h2>

  <input type="text" id="roomId" placeholder="Enter Room ID" />
  <button onclick="generateId()">Generate</button>
  <br>
  <button id="startBtn">Start</button>
  <button id="callBtn" disabled>Call</button>
  <button id="micBtn" disabled>Mic On</button>
  <button id="endBtn" disabled>End</button>

  <div id="status">Status: Waiting</div>
  <div id="users">Users in room: 1</div>

  <script>
    let localStream, currentCall, peer;
    let micEnabled = true;
    let peerId = '';

    function generateId() {
      const randomId = 'room' + Math.floor(Math.random() * 10000);
      document.getElementById('roomId').value = randomId;
    }

    document.getElementById('startBtn').onclick = function () {
      peerId = document.getElementById('roomId').value.trim();
      if (!peerId) return alert("Enter a Room ID");

      peer = new Peer(peerId, {
        host: 'peerjs.com',
        secure: true,
        port: 443
      });

      updateStatus("Connecting...");

      peer.on('open', () => {
        updateStatus(`Connected as ${peerId}`);
        document.getElementById('callBtn').disabled = false;
        document.getElementById('micBtn').disabled = false;
      });

      peer.on('call', (call) => {
        navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then((stream) => {
          localStream = stream;
          call.answer(stream);
          currentCall = call;
          handleCallStream(call);
        });
      });
    };

    document.getElementById('callBtn').onclick = function () {
      const remoteId = prompt("Enter Receiver ID:");
      if (!remoteId) return;

      updateStatus("Calling...");
      navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then((stream) => {
        localStream = stream;
        const call = peer.call(remoteId, stream);
        currentCall = call;
        handleCallStream(call);
      });
    };

    document.getElementById('endBtn').onclick = function () {
      if (currentCall) currentCall.close();
      updateStatus("Call ended.");
    };

    document.getElementById('micBtn').onclick = function () {
      if (!localStream) return;
      micEnabled = !micEnabled;
      localStream.getAudioTracks()[0].enabled = micEnabled;
      document.getElementById('micBtn').innerText = micEnabled ? "Mic On" : "Mic Off";
    };

    function handleCallStream(call) {
      call.on('stream', (remoteStream) => {
        const audio = new Audio();
        audio.srcObject = remoteStream;
        audio.play();
        updateStatus(`In call with ${call.peer}`);
        document.getElementById('endBtn').disabled = false;
      });

      call.on('close', () => {
        updateStatus("Peer ended call.");
        document.getElementById('endBtn').disabled = true;
      });
    }

    function updateStatus(msg) {
      document.getElementById('status').innerText = "Status: " + msg;
    }
  </script>
</body>
</html>
