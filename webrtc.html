<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Voice Call</title>
  <style>
    body { font-family: sans-serif; background: #0b0b0b; color: #fff; text-align: center; padding: 20px; }
    input, button { padding: 10px; margin: 8px; border-radius: 8px; font-size: 16px; border: none; width: 80%; max-width: 300px; }
    button { background: #0f9d58; color: #fff; cursor: pointer; }
    .hidden { display: none; }
    .info, h2 { margin-top: 10px; }
    .ringing { background: #111; padding: 20px; border-radius: 15px; margin-top: 20px; }
    .timer { font-size: 18px; margin-top: 5px; }
    .avatars { display: flex; justify-content: center; gap: 30px; margin: 10px 0; }
    .avatar { width: 70px; height: 70px; background: #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white; }
  </style>
</head>
<body>

<h2>Free Voice Call</h2>

<!-- Call Setup -->
<div id="setup">
  <input id="myId" placeholder="Create Room ID" />
  <button id="createBtn">Create</button>
  <hr style="width:80%;" />
  <input id="joinId" placeholder="Join Room ID" />
  <button id="joinBtn">Join</button>
</div>

<!-- Incoming Ringing -->
<div id="ringingUI" class="ringing hidden">
  <h3>Incoming Call...</h3>
  <audio id="ringtone" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" type="audio/ogg" />
  </audio>
  <button id="acceptBtn">Accept</button>
  <button id="rejectBtn">Reject</button>
</div>

<!-- Call UI -->
<div id="callUI" class="hidden">
  <div class="avatars">
    <div id="youAvatar" class="avatar">U</div>
    <div id="peerAvatar" class="avatar">P</div>
  </div>
  <div class="info" id="roomInfo"></div>
  <div class="info" id="status">Connecting...</div>
  <div class="info" id="users">Joined Users: 1</div>
  <div class="timer" id="callTimer">00:00</div>
  <button id="micBtn">Mic On</button>
  <button id="disconnectBtn">Disconnect</button>
</div>

<audio id="remoteAudio" autoplay></audio>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
let peer, localStream, currentCall, timerInterval, seconds = 0;
let userCount = 1;

const createBtn = document.getElementById("createBtn");
const joinBtn = document.getElementById("joinBtn");
const myIdInput = document.getElementById("myId");
const joinIdInput = document.getElementById("joinId");

const ringtone = document.getElementById("ringtone");
const acceptBtn = document.getElementById("acceptBtn");
const rejectBtn = document.getElementById("rejectBtn");

const setupUI = document.getElementById("setup");
const ringingUI = document.getElementById("ringingUI");
const callUI = document.getElementById("callUI");

const roomInfo = document.getElementById("roomInfo");
const status = document.getElementById("status");
const users = document.getElementById("users");
const callTimer = document.getElementById("callTimer");

const youAvatar = document.getElementById("youAvatar");
const peerAvatar = document.getElementById("peerAvatar");

const micBtn = document.getElementById("micBtn");
const disconnectBtn = document.getElementById("disconnectBtn");
const remoteAudio = document.getElementById("remoteAudio");

function startTimer() {
  seconds = 0;
  timerInterval = setInterval(() => {
    seconds++;
    const m = String(Math.floor(seconds / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    callTimer.innerText = `${m}:${s}`;
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
  callTimer.innerText = "00:00";
}

async function getMic() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    return true;
  } catch {
    alert("Mic access denied!");
    return false;
  }
}

function setAvatars(myId, peerId) {
  youAvatar.textContent = myId.slice(0, 2).toUpperCase();
  peerAvatar.textContent = peerId ? peerId.slice(0, 2).toUpperCase() : "--";
}

createBtn.onclick = async () => {
  const id = myIdInput.value.trim();
  if (!id) return alert("Enter your ID to create room.");
  if (!await getMic()) return;

  peer = new Peer(id);
  peer.on("open", () => {
    setupUI.classList.add("hidden");
    status.innerText = "Room Created. Waiting for call...";
    roomInfo.innerText = "Room ID: " + id;
    youAvatar.textContent = id.slice(0, 2).toUpperCase();
  });

  peer.on("call", call => {
    ringtone.play();
    ringingUI.classList.remove("hidden");

    acceptBtn.onclick = () => {
      ringtone.pause(); ringtone.currentTime = 0;
      ringingUI.classList.add("hidden");

      call.answer(localStream);
      call.on("stream", stream => {
        connected(stream, id, call.peer);
      });
      currentCall = call;
    };

    rejectBtn.onclick = () => {
      ringtone.pause(); ringtone.currentTime = 0;
      ringingUI.classList.add("hidden");
      call.close();
      status.innerText = "Call rejected.";
    };
  });
};

joinBtn.onclick = async () => {
  const id = joinIdInput.value.trim();
  if (!id) return alert("Enter Room ID.");
  if (!await getMic()) return;

  peer = new Peer();
  peer.on("open", () => {
    const call = peer.call(id, localStream);
    call.on("stream", stream => {
      connected(stream, id, peer.id);
    });
    currentCall = call;
  });
};

function connected(stream, id, peerId) {
  setupUI.classList.add("hidden");
  ringingUI.classList.add("hidden");
  callUI.classList.remove("hidden");
  remoteAudio.srcObject = stream;
  roomInfo.innerText = "Room ID: " + id;
  status.innerText = "Connected";
  userCount = 2;
  users.innerText = "Joined Users: " + userCount;
  setAvatars(id, peerId);
  startTimer();
}

micBtn.onclick = () => {
  const track = localStream.getAudioTracks()[0];
  track.enabled = !track.enabled;
  micBtn.innerText = track.enabled ? "Mic On" : "Mic Off";
};

disconnectBtn.onclick = () => {
  if (currentCall) currentCall.close();
  stopTimer();
  status.innerText = "Call Ended.";
  users.innerText = "Joined Users: 1";
  callUI.classList.add("hidden");
};

const urlParams = new URLSearchParams(location.search);
const room = urlParams.get("room");
if (room) {
  joinIdInput.value = room;
  joinBtn.click();
}
</script>
</body>
</html>
