<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Voice Call</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; text-align: center; padding: 20px; }
    input, button { padding: 10px; margin: 5px; border-radius: 8px; border: none; font-size: 16px; }
    button { background: #0f9d58; color: #fff; }
    .mic-muted { background: #888; }
  </style>
</head>
<body>
  <h2>Voice Call</h2>
  <input id="roomId" placeholder="Room ID" />
  <br />
  <button id="startBtn">Start / Join</button>
  <button id="callBtn" disabled>Call</button>
  <button id="micBtn" disabled>Mic On</button>
  <button id="shareBtn" disabled>Share</button>
  <div id="status">Status: Not connected</div>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const roomInput = document.getElementById("roomId");
      const startBtn = document.getElementById("startBtn");
      const callBtn = document.getElementById("callBtn");
      const micBtn = document.getElementById("micBtn");
      const shareBtn = document.getElementById("shareBtn");
      const status = document.getElementById("status");
      const remoteAudio = document.getElementById("remoteAudio");

      let peer, localStream, currentCall;

      startBtn.onclick = async () => {
        const id = roomInput.value.trim();
        if (!id) return alert("Enter Room ID");

        peer = new Peer(id);
        peer.on("open", () => {
          status.innerText = "Connected as: " + id;
          callBtn.disabled = false;
          micBtn.disabled = false;
          shareBtn.disabled = false;
        });

        peer.on("call", call => {
          call.answer(localStream);
          call.on("stream", stream => {
            remoteAudio.srcObject = stream;
            status.innerText = "In call with " + call.peer;
          });
          currentCall = call;
        });

        try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        } catch (err) {
          alert("Microphone access failed");
        }
      };

      callBtn.onclick = () => {
        const peerId = prompt("Enter peer ID:");
        if (!peerId || !localStream) return;
        const call = peer.call(peerId, localStream);
        call.on("stream", stream => {
          remoteAudio.srcObject = stream;
          status.innerText = "In call with " + call.peer;
        });
        currentCall = call;
      };

      micBtn.onclick = () => {
        const track = localStream.getAudioTracks()[0];
        track.enabled = !track.enabled;
        micBtn.innerText = track.enabled ? "Mic On" : "Mic Off";
      };

      shareBtn.onclick = () => {
        const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(roomInput.value)}`;
        navigator.clipboard.writeText(url).then(() => alert("Link copied:\n" + url));
      };

      // Auto-join if ?room= in URL
      const urlParams = new URLSearchParams(location.search);
      const roomParam = urlParams.get("room");
      if (roomParam) {
        roomInput.value = roomParam;
        startBtn.click();
      }
    });
  </script>
</body>
</html>
