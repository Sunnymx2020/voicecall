<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voice Call App</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f5f5f5; margin: 0; padding: 20px; }
    .hidden { display: none; }
    .card { background: #fff; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
    video { width: 100%; max-height: 200px; border-radius: 10px; margin-top: 10px; }
    .avatar { font-size: 2em; margin: 10px; background: #ddd; border-radius: 50%; width: 50px; height: 50px; line-height: 50px; display: inline-block; }
    .status { font-size: 1.2em; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="card" id="setupUI">
    <h2>Start a Voice Call</h2>
    <input id="myId" type="text" placeholder="Your Room ID" />
    <button id="createBtn">Create Room</button>
    <input id="joinId" type="text" placeholder="Enter Room to Join" />
    <button id="joinBtn">Join Room</button>
    <div class="status" id="status">Initializing...</div>
  </div>

  <div class="card hidden" id="callUI">
    <div id="roomInfo"></div>
    <div class="avatar" id="youAvatar"></div>
    <div class="avatar" id="peerAvatar"></div>
    <video id="localVideo" muted autoplay playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <div id="joinedUsers">Users: 1</div>
    <button id="shareBtn">Share</button>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const createBtn = document.getElementById("createBtn");
    const joinBtn = document.getElementById("joinBtn");
    const myId = document.getElementById("myId");
    const joinId = document.getElementById("joinId");
    const setupUI = document.getElementById("setupUI");
    const callUI = document.getElementById("callUI");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const roomInfo = document.getElementById("roomInfo");
    const youAvatar = document.getElementById("youAvatar");
    const peerAvatar = document.getElementById("peerAvatar");
    const status = document.getElementById("status");
    const shareBtn = document.getElementById("shareBtn");
    const joinedUsers = document.getElementById("joinedUsers");

    let localStream;
    let peer;
    let currentCall;

    async function getMic() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        localVideo.srcObject = localStream;
        return true;
      } catch (e) {
        alert("Mic access required!");
        return false;
      }
    }

    createBtn.onclick = async () => {
      if (!myId.value) return alert("Enter a Room ID to Create");
      if (!await getMic()) return;

      peer = new Peer(myId.value);

      peer.on("open", () => {
        setupUI.classList.add("hidden");
        callUI.classList.remove("hidden");
        status.innerText = "Room Created. Waiting for call...";
        roomInfo.innerText = "Room ID: " + myId.value;
        youAvatar.textContent = myId.value.slice(0, 2).toUpperCase();
      });

      peer.on("call", call => {
        currentCall = call;
        call.answer(localStream);
        call.on("stream", stream => remoteVideo.srcObject = stream);
        status.innerText = "Call Connected";
        peerAvatar.textContent = call.peer.slice(0, 2).toUpperCase();
        joinedUsers.innerText = "Users: 2";
      });

      peer.on("error", e => alert("Error: " + e));
    };

    joinBtn.onclick = async () => {
      if (!joinId.value) return alert("Enter Room ID to Join");
      if (!await getMic()) return;

      peer = new Peer();
      peer.on("open", () => {
        const call = peer.call(joinId.value, localStream);
        currentCall = call;
        call.on("stream", stream => remoteVideo.srcObject = stream);

        setupUI.classList.add("hidden");
        callUI.classList.remove("hidden");
        status.innerText = "Connected to Room";
        roomInfo.innerText = "Room ID: " + joinId.value;
        youAvatar.textContent = peer.id.slice(0, 2).toUpperCase();
        peerAvatar.textContent = joinId.value.slice(0, 2).toUpperCase();
        joinedUsers.innerText = "Users: 2";
      });

      peer.on("error", e => alert("Error: " + e));
    };

    shareBtn.onclick = () => {
      const id = myId.value || joinId.value || "";
      if (!id) return alert("No room to share");
      const url = location.origin + location.pathname + "?room=" + id;
      navigator.share ? navigator.share({ title: "Join My Call", url }) : prompt("Copy link:", url);
    };

    // Auto join if ?room= present
    const urlRoom = new URLSearchParams(location.search).get("room");
    if (urlRoom) {
      joinId.value = urlRoom;
      joinBtn.click();
    }
  </script>
</body>
</html>
